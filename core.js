"use strict";
/**
 * Created by user on 2019/3/17.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const clone = require("lodash/clone");
const iconv_jschardet_1 = require("iconv-jschardet");
const Bluebird = require("bluebird");
const stream = require("stream");
const util_1 = require("./util");
exports.SymFSLib = Symbol('fsLib');
function WrapFSIconv(fsLib) {
    let fs = clone(fsLib);
    Object.keys(fs)
        .forEach(k => {
        if (typeof fsLib[k] === 'function') {
            fs[k] = fsLib[k].bind(fsLib);
        }
    });
    fs[exports.SymFSLib] = fsLib;
    fs.iconv = iconv_jschardet_1.default;
    fs.ensureWriteStream = ensureWriteStream.bind(fs);
    fs.saveFile = saveFile.bind(fs);
    fs.saveFileSync = saveFileSync.bind(fs);
    fs.loadFileSync = loadFileSync.bind(fs);
    fs.loadFile = loadFile.bind(fs);
    fs._createStreamPassThrough = _createStreamPassThrough.bind(fs);
    fs._outputStream = _outputStream.bind(fs);
    fs._autoDecode = _autoDecode.bind(fs);
    fs.trimFilename = util_1.trimFilename;
    Object.defineProperty(exports, "__esModule", { value: true });
    // @ts-ignore
    fs.default = fs;
    return fs;
}
exports.WrapFSIconv = WrapFSIconv;
function ensureWriteStream(file) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    return fs.createWriteStream(file);
}
exports.ensureWriteStream = ensureWriteStream;
function saveFileSync(file, data, options = {}) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    if (options.encoding) {
        data = iconv_jschardet_1.default.encode(data, options.encoding);
    }
    fs.outputFileSync(file, data);
    return true;
}
exports.saveFileSync = saveFileSync;
function saveFile(file, data, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    return Bluebird
        .resolve(fs.ensureFile(file))
        .tap(function () {
        return new Bluebird(function (resolve, reject) {
            if (options.encoding) {
                data = iconv_jschardet_1.default.encode(data, options.encoding);
            }
            let readStream = self._createStreamPassThrough(data);
            let writeStream = self._outputStream(file, readStream);
            writeStream.on('error', reject);
            writeStream.on('finish', resolve);
        });
    })
        .thenReturn(true);
}
exports.saveFile = saveFile;
function _createStreamPassThrough(data) {
    let readStream = new stream.PassThrough();
    readStream.end(data);
    return readStream;
}
exports._createStreamPassThrough = _createStreamPassThrough;
function _outputStream(file, readStream) {
    let fs = this[exports.SymFSLib];
    let writeStream = fs.createWriteStream(file);
    readStream.pipe(writeStream);
    return writeStream;
}
exports._outputStream = _outputStream;
function _autoDecode(buf, options) {
    if (Array.isArray(options.autoDecode)) {
        let _do;
        let c = iconv_jschardet_1.default._enc(iconv_jschardet_1.default.detect(buf, true).name);
        for (let from of options.autoDecode) {
            let cd = iconv_jschardet_1.default.codec_data(from);
            let key;
            if (cd && cd.name) {
                key = iconv_jschardet_1.default._enc(cd.name);
                if (c === key) {
                    _do = key;
                    break;
                }
            }
        }
        if (_do) {
            return iconv_jschardet_1.default.encode(buf, null, options.encoding);
        }
        else {
            return buf;
        }
    }
    return iconv_jschardet_1.default.encode(buf);
}
exports._autoDecode = _autoDecode;
function loadFile(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFile(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = fs.readFile(file, ops)
                .then(function (buf) {
                return iconv_jschardet_1.default.decode(buf, options.encoding);
            });
        }
    }
    else if (options.autoDecode) {
        ps = fs.readFile(file, options)
            .then(function (buf) {
            return self._autoDecode(buf, options);
        });
    }
    else {
        ps = fs.readFile(file, options);
    }
    return Bluebird.resolve(ps);
}
exports.loadFile = loadFile;
function loadFileSync(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFileSync(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = iconv_jschardet_1.default.decode(fs.readFileSync(file, ops), options.encoding);
        }
    }
    else if (options.autoDecode) {
        ps = self._autoDecode(fs.readFileSync(file, options), options);
    }
    else {
        ps = fs.readFileSync(file, options);
    }
    return ps;
}
exports.loadFileSync = loadFileSync;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUlILHNDQUF1QztBQUN2QyxxREFBb0M7QUFDcEMscUNBQXNDO0FBQ3RDLGlDQUFrQztBQUNsQyxpQ0FBc0M7QUFHekIsUUFBQSxRQUFRLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRXhDLFNBQWdCLFdBQVcsQ0FBNEMsS0FBUTtJQUU5RSxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFrQyxDQUFDO0lBRXZELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ2IsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ1osSUFBSSxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLEVBQ2xDO1lBQ0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0I7SUFDRixDQUFDLENBQUMsQ0FDRjtJQUVELEVBQUUsQ0FBQyxnQkFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXJCLEVBQUUsQ0FBQyxLQUFLLEdBQUcseUJBQUssQ0FBQztJQUVqQixFQUFFLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELEVBQUUsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNoQyxFQUFFLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFeEMsRUFBRSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEVBQUUsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJ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Iiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOS8zLzE3LlxuICovXG5cbmltcG9ydCB7IHZFbmNvZGluZyB9IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgZnNFeHRyYSA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgY2xvbmUgPSByZXF1aXJlKFwibG9kYXNoL2Nsb25lXCIpO1xuaW1wb3J0IGljb252IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgQmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuaW1wb3J0IHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xuaW1wb3J0IHsgdHJpbUZpbGVuYW1lIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IElUU1JlcXVpcmVkV2l0aCwgSVRTUmVxdWlyZUF0TGVhc3RPbmUgfSBmcm9tICd0cy10eXBlJztcblxuZXhwb3J0IGNvbnN0IFN5bUZTTGliID0gU3ltYm9sKCdmc0xpYicpO1xuXG5leHBvcnQgZnVuY3Rpb24gV3JhcEZTSWNvbnY8RiBleHRlbmRzIHR5cGVvZiBmc0V4dHJhID0gdHlwZW9mIGZzRXh0cmE+KGZzTGliOiBGKTogV3JhcEZTSWNvbnYuSVdyYXBGUzxGPlxue1xuXHRsZXQgZnMgPSBjbG9uZShmc0xpYikgYXMgYW55IGFzIFdyYXBGU0ljb252LklXcmFwRlM8Rj47XG5cblx0T2JqZWN0LmtleXMoZnMpXG5cdFx0LmZvckVhY2goayA9PiB7XG5cdFx0XHRpZiAodHlwZW9mIGZzTGliW2tdID09PSAnZnVuY3Rpb24nKVxuXHRcdFx0e1xuXHRcdFx0XHRmc1trXSA9IGZzTGliW2tdLmJpbmQoZnNMaWIpO1xuXHRcdFx0fVxuXHRcdH0pXG5cdDtcblxuXHRmc1tTeW1GU0xpYl0gPSBmc0xpYjtcblxuXHRmcy5pY29udiA9IGljb252O1xuXG5cdGZzLmVuc3VyZVdyaXRlU3RyZWFtID0gZW5zdXJlV3JpdGVTdHJlYW0uYmluZChmcyk7XG5cdGZzLnNhdmVGaWxlID0gc2F2ZUZpbGUuYmluZChmcyk7XG5cdGZzLnNhdmVGaWxlU3luYyA9IHNhdmVGaWxlU3luYy5iaW5kKGZzKTtcblxuXHRmcy5sb2FkRmlsZVN5bmMgPSBsb2FkRmlsZVN5bmMuYmluZChmcyk7XG5cdGZzLmxvYWRGaWxlID0gbG9hZEZpbGUuYmluZChmcyk7XG5cblx0ZnMuX2NyZWF0ZVN0cmVhbVBhc3NUaHJvdWdoID0gX2NyZWF0ZVN0cmVhbVBhc3NUaHJvdWdoLmJpbmQoZnMpO1xuXHRmcy5fb3V0cHV0U3RyZWFtID0gX291dHB1dFN0cmVhbS5iaW5kKGZzKTtcblx0ZnMuX2F1dG9EZWNvZGUgPSBfYXV0b0RlY29kZS5iaW5kKGZzKTtcblxuXHRmcy50cmltRmlsZW5hbWUgPSB0cmltRmlsZW5hbWU7XG5cblx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuXG5cdC8vIEB0cy1pZ25vcmVcblx0ZnMuZGVmYXVsdCA9IGZzO1xuXG5cdHJldHVybiBmcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZVdyaXRlU3RyZWFtKGZpbGU6IHN0cmluZylcbntcblx0bGV0IGZzID0gKHRoaXMgYXMgYW55IGFzIFdyYXBGU0ljb252LklXcmFwRlMpW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRmcy5lbnN1cmVGaWxlU3luYyhmaWxlKTtcblx0cmV0dXJuIGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGVTeW5jKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9ucyA9IHt9KVxue1xuXHRsZXQgZnMgPSAodGhpcyBhcyBhbnkgYXMgV3JhcEZTSWNvbnYuSVdyYXBGUylbU3ltRlNMaWJdIGFzIHR5cGVvZiBmc0V4dHJhO1xuXG5cdGZzLmVuc3VyZUZpbGVTeW5jKGZpbGUpO1xuXG5cdGlmIChvcHRpb25zLmVuY29kaW5nKVxuXHR7XG5cdFx0ZGF0YSA9IGljb252LmVuY29kZShkYXRhLCBvcHRpb25zLmVuY29kaW5nKTtcblx0fVxuXG5cdGZzLm91dHB1dEZpbGVTeW5jKGZpbGUsIGRhdGEpO1xuXG5cdHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGUoZmlsZTogc3RyaW5nLCBkYXRhLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zID0ge30pXG57XG5cdGxldCBzZWxmOiBXcmFwRlNJY29udi5JV3JhcEZTPHR5cGVvZiBmc0V4dHJhPiA9IHRoaXM7XG5cdGxldCBmcyA9IHNlbGZbU3ltRlNMaWJdIGFzIHR5cGVvZiBmc0V4dHJhO1xuXG5cdHJldHVybiBCbHVlYmlyZFxuXHRcdC5yZXNvbHZlKGZzLmVuc3VyZUZpbGUoZmlsZSkpXG5cdFx0LnRhcChmdW5jdGlvbiAoKVxuXHRcdHtcblx0XHRcdHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHRcdHtcblx0XHRcdFx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRkYXRhID0gaWNvbnYuZW5jb2RlKGRhdGEsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IHJlYWRTdHJlYW0gPSBzZWxmLl9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaChkYXRhKTtcblx0XHRcdFx0bGV0IHdyaXRlU3RyZWFtID0gc2VsZi5fb3V0cHV0U3RyZWFtKGZpbGUsIHJlYWRTdHJlYW0pO1xuXG5cdFx0XHRcdHdyaXRlU3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG5cdFx0XHRcdHdyaXRlU3RyZWFtLm9uKCdmaW5pc2gnLCByZXNvbHZlKTtcblx0XHRcdH0pXG5cdFx0fSlcblx0XHQudGhlblJldHVybih0cnVlKVxuXHRcdDtcbn1cblxuZXhwb3J0IGRlY2xhcmUgbmFtZXNwYWNlIFdyYXBGU0ljb252XG57XG5cdGV4cG9ydCB0eXBlIElXcmFwRlM8RiBleHRlbmRzIHR5cGVvZiBmc0V4dHJhID0gdHlwZW9mIGZzRXh0cmE+ID0gRiAmXG5cdHtcblx0XHRbU3ltRlNMaWJdOiBGIHwgdHlwZW9mIGZzRXh0cmE7XG5cblx0XHRpY29udjogdHlwZW9mIGljb252O1xuXHRcdGVuc3VyZVdyaXRlU3RyZWFtKGZpbGU6IHN0cmluZyk6IGZzRXh0cmEuV3JpdGVTdHJlYW07XG5cblx0XHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5cdFx0c2F2ZUZpbGUoZmlsZTogc3RyaW5nLCBkYXRhLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9ucyk6IEJsdWViaXJkPGJvb2xlYW4+O1xuXG5cdFx0c2F2ZUZpbGVTeW5jKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnMpOiBib29sZWFuXG5cblx0XHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5cdFx0bG9hZEZpbGU8VCA9IHN0cmluZz4oZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUyKTogQmx1ZWJpcmQ8VD47XG5cdFx0bG9hZEZpbGU8VCA9IEJ1ZmZlcj4oZmlsZTogc3RyaW5nLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQmx1ZWJpcmQ8VD47XG5cblx0XHRsb2FkRmlsZVN5bmM8VCA9IHN0cmluZz4oZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUyKTogVDtcblx0XHRsb2FkRmlsZVN5bmM8VCA9IEJ1ZmZlcj4oZmlsZTogc3RyaW5nLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogVDtcblxuXHRcdC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cblx0XHRfY3JlYXRlU3RyZWFtUGFzc1Rocm91Z2goZGF0YTogdW5rbm93bik6IHN0cmVhbS5SZWFkYWJsZTtcblx0XHRfb3V0cHV0U3RyZWFtKGZpbGU6IHN0cmluZywgcmVhZFN0cmVhbTogc3RyZWFtLlJlYWRhYmxlKTogZnNFeHRyYS5Xcml0ZVN0cmVhbTtcblxuXHRcdF9hdXRvRGVjb2RlPFQ+KGJ1ZjogVCwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlICYge1xuXHRcdFx0YXV0b0RlY29kZTogdHJ1ZSB8IHN0cmluZ1tdO1xuXHRcdH0pOiBUIHwgc3RyaW5nIHwgQnVmZmVyO1xuXHRcdF9hdXRvRGVjb2RlKGJ1ZjogdW5rbm93biwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQnVmZmVyO1xuXG5cdFx0Ly8gLS0tLS0tLS0tLVxuXG5cdFx0dHJpbUZpbGVuYW1lKG5hbWU6IHVua25vd24pOiBzdHJpbmdcblx0fVxuXG5cdGV4cG9ydCBpbnRlcmZhY2UgSVdyYXBGU0ljb252T3B0aW9uc1xuXHR7XG5cdFx0ZW5jb2Rpbmc/OiB2RW5jb2Rpbmc7XG5cdH1cblxuXHRleHBvcnQgaW50ZXJmYWNlIElXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZVxuXHR7XG5cdFx0ZW5jb2Rpbmc/OiBzdHJpbmc7XG5cdFx0ZmxhZz86IHN0cmluZztcblxuXHRcdGF1dG9EZWNvZGU/OiBib29sZWFuIHwgc3RyaW5nW10sXG5cdH1cblxuXHRleHBvcnQgdHlwZSBJV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUyID0gSVRTUmVxdWlyZUF0TGVhc3RPbmU8SVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlLCAnZW5jb2RpbmcnIHwgJ2F1dG9EZWNvZGUnPlxuXG5cdGV4cG9ydCB0eXBlIElFbmNvZGluZyA9IHZFbmNvZGluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2NyZWF0ZVN0cmVhbVBhc3NUaHJvdWdoKGRhdGEpOiBzdHJlYW0uUmVhZGFibGVcbntcblx0bGV0IHJlYWRTdHJlYW0gPSBuZXcgc3RyZWFtLlBhc3NUaHJvdWdoKCk7XG5cdHJlYWRTdHJlYW0uZW5kKGRhdGEpO1xuXHRyZXR1cm4gcmVhZFN0cmVhbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9vdXRwdXRTdHJlYW0oZmlsZTogc3RyaW5nLCByZWFkU3RyZWFtOiBzdHJlYW0uUmVhZGFibGUpOiBmc0V4dHJhLldyaXRlU3RyZWFtXG57XG5cdGxldCBmcyA9ICh0aGlzIGFzIGFueSBhcyBXcmFwRlNJY29udi5JV3JhcEZTKVtTeW1GU0xpYl0gYXMgdHlwZW9mIGZzRXh0cmE7XG5cblx0bGV0IHdyaXRlU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZSk7XG5cdHJlYWRTdHJlYW0ucGlwZSh3cml0ZVN0cmVhbSk7XG5cdHJldHVybiB3cml0ZVN0cmVhbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hdXRvRGVjb2RlPFQ+KGJ1ZjogVCwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlICYge1xuXHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW10sXG59KTogVCB8IHN0cmluZyB8IEJ1ZmZlclxuZXhwb3J0IGZ1bmN0aW9uIF9hdXRvRGVjb2RlKGJ1Ziwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQnVmZmVyXG5leHBvcnQgZnVuY3Rpb24gX2F1dG9EZWNvZGUoYnVmLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBzdHJpbmcgfCBCdWZmZXJcbntcblx0aWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucy5hdXRvRGVjb2RlKSlcblx0e1xuXHRcdGxldCBfZG86IHN0cmluZztcblx0XHRsZXQgYyA9IGljb252Ll9lbmMoaWNvbnYuZGV0ZWN0KGJ1ZiwgdHJ1ZSkubmFtZSk7XG5cblx0XHRmb3IgKGxldCBmcm9tIG9mIChvcHRpb25zLmF1dG9EZWNvZGUgYXMgc3RyaW5nW10pKVxuXHRcdHtcblx0XHRcdGxldCBjZCA9IGljb252LmNvZGVjX2RhdGEoZnJvbSk7XG5cdFx0XHRsZXQga2V5OiBzdHJpbmc7XG5cblx0XHRcdGlmIChjZCAmJiBjZC5uYW1lKVxuXHRcdFx0e1xuXHRcdFx0XHRrZXkgPSBpY29udi5fZW5jKGNkLm5hbWUpO1xuXG5cdFx0XHRcdGlmIChjID09PSBrZXkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRfZG8gPSBrZXk7XG5cblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChfZG8pXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGljb252LmVuY29kZShidWYsIG51bGwsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGJ1Zjtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaWNvbnYuZW5jb2RlKGJ1Zik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZTxUID0gc3RyaW5nPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZTIpOiBCbHVlYmlyZDxUPlxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlPFQgPSBCdWZmZXI+KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IEJsdWViaXJkPFQ+XG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGUoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSB7fSk6IEJsdWViaXJkPEJ1ZmZlciB8IHN0cmluZz5cbntcblx0bGV0IHNlbGY6IFdyYXBGU0ljb252LklXcmFwRlM8dHlwZW9mIGZzRXh0cmE+ID0gdGhpcztcblx0bGV0IGZzID0gc2VsZltTeW1GU0xpYl0gYXMgdHlwZW9mIGZzRXh0cmE7XG5cblx0bGV0IHBzOiBQcm9taXNlPGFueT47XG5cblx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdHtcblx0XHRsZXQgZW5jID0gaWNvbnYuaXNOb2RlRW5jb2Rpbmcob3B0aW9ucy5lbmNvZGluZyk7XG5cblx0XHRpZiAoZW5jKVxuXHRcdHtcblx0XHRcdHBzID0gZnMucmVhZEZpbGUoZmlsZSwgb3B0aW9ucyk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRsZXQgb3BzOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcblx0XHRcdGRlbGV0ZSBvcHMuZW5jb2Rpbmc7XG5cblx0XHRcdHBzID0gZnMucmVhZEZpbGUoZmlsZSwgb3BzKVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbiAoYnVmKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIGljb252LmRlY29kZShidWYsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdFx0XHR9KVxuXHRcdFx0O1xuXHRcdH1cblx0fVxuXHRlbHNlIGlmIChvcHRpb25zLmF1dG9EZWNvZGUpXG5cdHtcblx0XHRwcyA9IGZzLnJlYWRGaWxlKGZpbGUsIG9wdGlvbnMpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAoYnVmKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gc2VsZi5fYXV0b0RlY29kZShidWYsIG9wdGlvbnMpO1xuXHRcdFx0fSlcblx0XHQ7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0cHMgPSBmcy5yZWFkRmlsZShmaWxlLCBvcHRpb25zKTtcblx0fVxuXG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHBzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlU3luYzxUID0gc3RyaW5nPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZTIpOiBUXG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGVTeW5jPFQgPSBCdWZmZXI+KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IFRcbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZVN5bmMoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSB7fSk6IEJ1ZmZlciB8IHN0cmluZ1xue1xuXHRsZXQgc2VsZjogV3JhcEZTSWNvbnYuSVdyYXBGUzx0eXBlb2YgZnNFeHRyYT4gPSB0aGlzO1xuXHRsZXQgZnMgPSBzZWxmW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRsZXQgcHM7XG5cblx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdHtcblx0XHRsZXQgZW5jID0gaWNvbnYuaXNOb2RlRW5jb2Rpbmcob3B0aW9ucy5lbmNvZGluZyk7XG5cblx0XHRpZiAoZW5jKVxuXHRcdHtcblx0XHRcdHBzID0gZnMucmVhZEZpbGVTeW5jKGZpbGUsIG9wdGlvbnMpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0bGV0IG9wczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG5cdFx0XHRkZWxldGUgb3BzLmVuY29kaW5nO1xuXG5cdFx0XHRwcyA9IGljb252LmRlY29kZShmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3BzKSwgb3B0aW9ucy5lbmNvZGluZyk7XG5cdFx0fVxuXHR9XG5cdGVsc2UgaWYgKG9wdGlvbnMuYXV0b0RlY29kZSlcblx0e1xuXHRcdHBzID0gc2VsZi5fYXV0b0RlY29kZShmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3B0aW9ucyksIG9wdGlvbnMpO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdHBzID0gZnMucmVhZEZpbGVTeW5jKGZpbGUsIG9wdGlvbnMpO1xuXHR9XG5cblx0cmV0dXJuIHBzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vY29yZScpO1xuIl19