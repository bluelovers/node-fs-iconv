"use strict";
/**
 * Created by user on 2019/3/17.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const clone = require("lodash/clone");
const iconv_jschardet_1 = require("iconv-jschardet");
const Bluebird = require("bluebird");
const stream = require("stream");
const util_1 = require("./util");
exports.SymFSLib = Symbol('fsLib');
function WrapFSIconv(fsLib) {
    let fs = clone(fsLib);
    Object.keys(fs)
        .forEach(k => {
        if (typeof fsLib[k] === 'function') {
            fs[k] = fsLib[k].bind(fsLib[k], fsLib);
        }
    });
    fs[exports.SymFSLib] = fsLib;
    fs.iconv = iconv_jschardet_1.default;
    fs.ensureWriteStream = ensureWriteStream.bind(fs);
    fs.saveFile = saveFile.bind(fs);
    fs.saveFileSync = saveFileSync.bind(fs);
    fs.loadFileSync = loadFileSync.bind(fs);
    fs.loadFile = loadFile.bind(fs);
    fs._createStreamPassThrough = _createStreamPassThrough.bind(fs);
    fs._outputStream = _outputStream.bind(fs);
    fs._autoDecode = _autoDecode.bind(fs);
    fs.trimFilename = util_1.trimFilename;
    Object.defineProperty(exports, "__esModule", { value: true });
    // @ts-ignore
    fs.default = fs;
    return fs;
}
exports.WrapFSIconv = WrapFSIconv;
function ensureWriteStream(file) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    return fs.createWriteStream(file);
}
exports.ensureWriteStream = ensureWriteStream;
function saveFileSync(file, data, options = {}) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    if (options.encoding) {
        data = iconv_jschardet_1.default.encode(data, options.encoding);
    }
    fs.outputFileSync(file, data);
    return true;
}
exports.saveFileSync = saveFileSync;
function saveFile(file, data, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    return Bluebird
        .resolve(fs.ensureFile(file))
        .tap(function () {
        return new Bluebird(function (resolve, reject) {
            if (options.encoding) {
                data = iconv_jschardet_1.default.encode(data, options.encoding);
            }
            let readStream = self._createStreamPassThrough(data);
            let writeStream = self._outputStream(file, readStream);
            writeStream.on('error', reject);
            writeStream.on('finish', resolve);
        });
    })
        .thenReturn(true);
}
exports.saveFile = saveFile;
function _createStreamPassThrough(data) {
    let readStream = new stream.PassThrough();
    readStream.end(data);
    return readStream;
}
exports._createStreamPassThrough = _createStreamPassThrough;
function _outputStream(file, readStream) {
    let fs = this[exports.SymFSLib];
    let writeStream = fs.createWriteStream(file);
    readStream.pipe(writeStream);
    return writeStream;
}
exports._outputStream = _outputStream;
function _autoDecode(buf, options) {
    if (Array.isArray(options.autoDecode)) {
        let _do;
        let c = iconv_jschardet_1.default._enc(iconv_jschardet_1.default.detect(buf, true).name);
        for (let from of options.autoDecode) {
            let cd = iconv_jschardet_1.default.codec_data(from);
            let key;
            if (cd && cd.name) {
                key = iconv_jschardet_1.default._enc(cd.name);
                if (c === key) {
                    _do = key;
                    break;
                }
            }
        }
        if (_do) {
            return iconv_jschardet_1.default.encode(buf, null, options.encoding);
        }
        else {
            return buf;
        }
    }
    return iconv_jschardet_1.default.encode(buf);
}
exports._autoDecode = _autoDecode;
function loadFile(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFile(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = fs.readFile(file, ops)
                .then(function (buf) {
                return iconv_jschardet_1.default.decode(buf, options.encoding);
            });
        }
    }
    else if (options.autoDecode) {
        ps = fs.readFile(file, options)
            .then(function (buf) {
            return self._autoDecode(buf, options);
        });
    }
    else {
        ps = fs.readFile(file, options);
    }
    return Bluebird.resolve(ps);
}
exports.loadFile = loadFile;
function loadFileSync(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFileSync(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = iconv_jschardet_1.default.decode(fs.readFileSync(file, ops), options.encoding);
        }
    }
    else if (options.autoDecode) {
        ps = self._autoDecode(fs.readFileSync(file, options), options);
    }
    else {
        ps = fs.readFileSync(file, options);
    }
    return ps;
}
exports.loadFileSync = loadFileSync;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUlILHNDQUF1QztBQUN2QyxxREFBb0M7QUFDcEMscUNBQXNDO0FBQ3RDLGlDQUFrQztBQUNsQyxpQ0FBc0M7QUFFekIsUUFBQSxRQUFRLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRXhDLFNBQWdCLFdBQVcsQ0FBNEMsS0FBUTtJQUU5RSxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUEyQixDQUFDO0lBRWhELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ2IsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ1osSUFBSSxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLEVBQ2xDO1lBQ0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0YsQ0FBQyxDQUFDLENBQ0Y7SUFFRCxFQUFFLENBQUMsZ0JBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUVyQixFQUFFLENBQUMsS0FBSyxHQUFHLHlCQUFLLENBQUM7SUFFakIsRUFBRSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNsRCxFQUFFLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDaEMsRUFBRSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXhDLEVBQUUsQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4QyxFQUFFLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxJ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aUNDO0FBRUQsa0JBQWUsT0FBa0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTkvMy8xNy5cbiAqL1xuXG5pbXBvcnQgeyB2RW5jb2RpbmcgfSBmcm9tICdpY29udi1qc2NoYXJkZXQnO1xuaW1wb3J0IGZzRXh0cmEgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IGNsb25lID0gcmVxdWlyZShcImxvZGFzaC9jbG9uZVwiKTtcbmltcG9ydCBpY29udiBmcm9tICdpY29udi1qc2NoYXJkZXQnO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbmltcG9ydCB7IHRyaW1GaWxlbmFtZSB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCBjb25zdCBTeW1GU0xpYiA9IFN5bWJvbCgnZnNMaWInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIFdyYXBGU0ljb252PEYgZXh0ZW5kcyB0eXBlb2YgZnNFeHRyYSA9IHR5cGVvZiBmc0V4dHJhPihmc0xpYjogRik6IFdyYXBGU0ljb252LklXcmFwRlM8Rj5cbntcblx0bGV0IGZzID0gY2xvbmUoZnNMaWIpIGFzIFdyYXBGU0ljb252LklXcmFwRlM8Rj47XG5cblx0T2JqZWN0LmtleXMoZnMpXG5cdFx0LmZvckVhY2goayA9PiB7XG5cdFx0XHRpZiAodHlwZW9mIGZzTGliW2tdID09PSAnZnVuY3Rpb24nKVxuXHRcdFx0e1xuXHRcdFx0XHRmc1trXSA9IGZzTGliW2tdLmJpbmQoZnNMaWJba10sIGZzTGliKTtcblx0XHRcdH1cblx0XHR9KVxuXHQ7XG5cblx0ZnNbU3ltRlNMaWJdID0gZnNMaWI7XG5cblx0ZnMuaWNvbnYgPSBpY29udjtcblxuXHRmcy5lbnN1cmVXcml0ZVN0cmVhbSA9IGVuc3VyZVdyaXRlU3RyZWFtLmJpbmQoZnMpO1xuXHRmcy5zYXZlRmlsZSA9IHNhdmVGaWxlLmJpbmQoZnMpO1xuXHRmcy5zYXZlRmlsZVN5bmMgPSBzYXZlRmlsZVN5bmMuYmluZChmcyk7XG5cblx0ZnMubG9hZEZpbGVTeW5jID0gbG9hZEZpbGVTeW5jLmJpbmQoZnMpO1xuXHRmcy5sb2FkRmlsZSA9IGxvYWRGaWxlLmJpbmQoZnMpO1xuXG5cdGZzLl9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaCA9IF9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaC5iaW5kKGZzKTtcblx0ZnMuX291dHB1dFN0cmVhbSA9IF9vdXRwdXRTdHJlYW0uYmluZChmcyk7XG5cdGZzLl9hdXRvRGVjb2RlID0gX2F1dG9EZWNvZGUuYmluZChmcyk7XG5cblx0ZnMudHJpbUZpbGVuYW1lID0gdHJpbUZpbGVuYW1lO1xuXG5cdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcblxuXHQvLyBAdHMtaWdub3JlXG5cdGZzLmRlZmF1bHQgPSBmcztcblxuXHRyZXR1cm4gZnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbnN1cmVXcml0ZVN0cmVhbShmaWxlOiBzdHJpbmcpXG57XG5cdGxldCBmcyA9ICh0aGlzIGFzIGFueSBhcyBXcmFwRlNJY29udi5JV3JhcEZTKVtTeW1GU0xpYl0gYXMgdHlwZW9mIGZzRXh0cmE7XG5cblx0ZnMuZW5zdXJlRmlsZVN5bmMoZmlsZSk7XG5cdHJldHVybiBmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVGaWxlU3luYyhmaWxlOiBzdHJpbmcsIGRhdGEsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnMgPSB7fSlcbntcblx0bGV0IGZzID0gKHRoaXMgYXMgYW55IGFzIFdyYXBGU0ljb252LklXcmFwRlMpW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRmcy5lbnN1cmVGaWxlU3luYyhmaWxlKTtcblxuXHRpZiAob3B0aW9ucy5lbmNvZGluZylcblx0e1xuXHRcdGRhdGEgPSBpY29udi5lbmNvZGUoZGF0YSwgb3B0aW9ucy5lbmNvZGluZyk7XG5cdH1cblxuXHRmcy5vdXRwdXRGaWxlU3luYyhmaWxlLCBkYXRhKTtcblxuXHRyZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVGaWxlKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9ucyA9IHt9KVxue1xuXHRsZXQgc2VsZjogV3JhcEZTSWNvbnYuSVdyYXBGUzx0eXBlb2YgZnNFeHRyYT4gPSB0aGlzO1xuXHRsZXQgZnMgPSBzZWxmW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRyZXR1cm4gQmx1ZWJpcmRcblx0XHQucmVzb2x2ZShmcy5lbnN1cmVGaWxlKGZpbGUpKVxuXHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHR7XG5cdFx0XHRyZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChvcHRpb25zLmVuY29kaW5nKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0ZGF0YSA9IGljb252LmVuY29kZShkYXRhLCBvcHRpb25zLmVuY29kaW5nKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxldCByZWFkU3RyZWFtID0gc2VsZi5fY3JlYXRlU3RyZWFtUGFzc1Rocm91Z2goZGF0YSk7XG5cdFx0XHRcdGxldCB3cml0ZVN0cmVhbSA9IHNlbGYuX291dHB1dFN0cmVhbShmaWxlLCByZWFkU3RyZWFtKTtcblxuXHRcdFx0XHR3cml0ZVN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuXHRcdFx0XHR3cml0ZVN0cmVhbS5vbignZmluaXNoJywgcmVzb2x2ZSk7XG5cdFx0XHR9KVxuXHRcdH0pXG5cdFx0LnRoZW5SZXR1cm4odHJ1ZSlcblx0XHQ7XG59XG5cbmV4cG9ydCBkZWNsYXJlIG5hbWVzcGFjZSBXcmFwRlNJY29udlxue1xuXHRleHBvcnQgdHlwZSBJV3JhcEZTPEYgZXh0ZW5kcyB0eXBlb2YgZnNFeHRyYSA9IHR5cGVvZiBmc0V4dHJhPiA9IEYgJlxuXHR7XG5cdFx0W1N5bUZTTGliXTogRiB8IHR5cGVvZiBmc0V4dHJhO1xuXG5cdFx0aWNvbnY6IHR5cGVvZiBpY29udjtcblx0XHRlbnN1cmVXcml0ZVN0cmVhbShmaWxlOiBzdHJpbmcpOiBmc0V4dHJhLldyaXRlU3RyZWFtO1xuXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRcdHNhdmVGaWxlKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnMpOiBCbHVlYmlyZDxib29sZWFuPjtcblxuXHRcdHNhdmVGaWxlU3luYyhmaWxlOiBzdHJpbmcsIGRhdGEsIG9wdGlvbnM/OiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zKTogYm9vbGVhblxuXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRcdGxvYWRGaWxlPFQgPSBzdHJpbmc+KGZpbGU6IHN0cmluZywgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlMiAmICh7XG5cdFx0XHRlbmNvZGluZzogc3RyaW5nO1xuXHRcdH0gfCB7XG5cdFx0XHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW107XG5cdFx0fSkpOiBCbHVlYmlyZDxUPjtcblx0XHRsb2FkRmlsZTxUID0gQnVmZmVyPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM/OiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBCbHVlYmlyZDxUPjtcblxuXHRcdGxvYWRGaWxlU3luYzxUID0gc3RyaW5nPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZTIgJiAoe1xuXHRcdFx0ZW5jb2Rpbmc6IHN0cmluZztcblx0XHR9IHwge1xuXHRcdFx0YXV0b0RlY29kZTogdHJ1ZSB8IHN0cmluZ1tdO1xuXHRcdH0pKTogVDtcblx0XHRsb2FkRmlsZVN5bmM8VCA9IEJ1ZmZlcj4oZmlsZTogc3RyaW5nLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogVDtcblxuXHRcdC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cblx0XHRfY3JlYXRlU3RyZWFtUGFzc1Rocm91Z2goZGF0YTogdW5rbm93bik6IHN0cmVhbS5SZWFkYWJsZTtcblx0XHRfb3V0cHV0U3RyZWFtKGZpbGU6IHN0cmluZywgcmVhZFN0cmVhbTogc3RyZWFtLlJlYWRhYmxlKTogZnNFeHRyYS5Xcml0ZVN0cmVhbTtcblxuXHRcdF9hdXRvRGVjb2RlPFQ+KGJ1ZjogVCwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlICYge1xuXHRcdFx0YXV0b0RlY29kZTogdHJ1ZSB8IHN0cmluZ1tdO1xuXHRcdH0pOiBUIHwgc3RyaW5nIHwgQnVmZmVyO1xuXHRcdF9hdXRvRGVjb2RlKGJ1ZjogdW5rbm93biwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQnVmZmVyO1xuXG5cdFx0Ly8gLS0tLS0tLS0tLVxuXG5cdFx0dHJpbUZpbGVuYW1lKG5hbWU6IHVua25vd24pOiBzdHJpbmdcblx0fVxuXG5cdGV4cG9ydCBpbnRlcmZhY2UgSVdyYXBGU0ljb252T3B0aW9uc1xuXHR7XG5cdFx0ZW5jb2Rpbmc/OiB2RW5jb2Rpbmc7XG5cdH1cblxuXHRleHBvcnQgaW50ZXJmYWNlIElXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZVxuXHR7XG5cdFx0ZW5jb2Rpbmc/OiBzdHJpbmc7XG5cdFx0ZmxhZz86IHN0cmluZztcblxuXHRcdGF1dG9EZWNvZGU/OiBib29sZWFuIHwgc3RyaW5nW10sXG5cdH1cblxuXHRleHBvcnQgdHlwZSBJV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUyID0gSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlICYge1xuXHRcdGVuY29kaW5nOiBzdHJpbmc7XG5cdH07XG5cblx0ZXhwb3J0IHR5cGUgSUVuY29kaW5nID0gdkVuY29kaW5nXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfY3JlYXRlU3RyZWFtUGFzc1Rocm91Z2goZGF0YSk6IHN0cmVhbS5SZWFkYWJsZVxue1xuXHRsZXQgcmVhZFN0cmVhbSA9IG5ldyBzdHJlYW0uUGFzc1Rocm91Z2goKTtcblx0cmVhZFN0cmVhbS5lbmQoZGF0YSk7XG5cdHJldHVybiByZWFkU3RyZWFtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX291dHB1dFN0cmVhbShmaWxlOiBzdHJpbmcsIHJlYWRTdHJlYW06IHN0cmVhbS5SZWFkYWJsZSk6IGZzRXh0cmEuV3JpdGVTdHJlYW1cbntcblx0bGV0IGZzID0gKHRoaXMgYXMgYW55IGFzIFdyYXBGU0ljb252LklXcmFwRlMpW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRsZXQgd3JpdGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlKTtcblx0cmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcblx0cmV0dXJuIHdyaXRlU3RyZWFtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2F1dG9EZWNvZGU8VD4oYnVmOiBULCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgJiB7XG5cdGF1dG9EZWNvZGU6IHRydWUgfCBzdHJpbmdbXSxcbn0pOiBUIHwgc3RyaW5nIHwgQnVmZmVyXG5leHBvcnQgZnVuY3Rpb24gX2F1dG9EZWNvZGUoYnVmLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBCdWZmZXJcbmV4cG9ydCBmdW5jdGlvbiBfYXV0b0RlY29kZShidWYsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IHN0cmluZyB8IEJ1ZmZlclxue1xuXHRpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zLmF1dG9EZWNvZGUpKVxuXHR7XG5cdFx0bGV0IF9kbzogc3RyaW5nO1xuXHRcdGxldCBjID0gaWNvbnYuX2VuYyhpY29udi5kZXRlY3QoYnVmLCB0cnVlKS5uYW1lKTtcblxuXHRcdGZvciAobGV0IGZyb20gb2YgKG9wdGlvbnMuYXV0b0RlY29kZSBhcyBzdHJpbmdbXSkpXG5cdFx0e1xuXHRcdFx0bGV0IGNkID0gaWNvbnYuY29kZWNfZGF0YShmcm9tKTtcblx0XHRcdGxldCBrZXk6IHN0cmluZztcblxuXHRcdFx0aWYgKGNkICYmIGNkLm5hbWUpXG5cdFx0XHR7XG5cdFx0XHRcdGtleSA9IGljb252Ll9lbmMoY2QubmFtZSk7XG5cblx0XHRcdFx0aWYgKGMgPT09IGtleSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdF9kbyA9IGtleTtcblxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKF9kbylcblx0XHR7XG5cdFx0XHRyZXR1cm4gaWNvbnYuZW5jb2RlKGJ1ZiwgbnVsbCwgb3B0aW9ucy5lbmNvZGluZyk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRyZXR1cm4gYnVmO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBpY29udi5lbmNvZGUoYnVmKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlPFQgPSBzdHJpbmc+KGZpbGU6IHN0cmluZywgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlMiAmICh7XG5cdGVuY29kaW5nOiBzdHJpbmcsXG59IHwge1xuXHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW10sXG59KSk6IEJsdWViaXJkPFQ+XG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGU8VCA9IEJ1ZmZlcj4oZmlsZTogc3RyaW5nLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQmx1ZWJpcmQ8VD5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZShmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSA9IHt9KTogQmx1ZWJpcmQ8QnVmZmVyIHwgc3RyaW5nPlxue1xuXHRsZXQgc2VsZjogV3JhcEZTSWNvbnYuSVdyYXBGUzx0eXBlb2YgZnNFeHRyYT4gPSB0aGlzO1xuXHRsZXQgZnMgPSBzZWxmW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRsZXQgcHM6IFByb21pc2U8YW55PjtcblxuXHRpZiAob3B0aW9ucy5lbmNvZGluZylcblx0e1xuXHRcdGxldCBlbmMgPSBpY29udi5pc05vZGVFbmNvZGluZyhvcHRpb25zLmVuY29kaW5nKTtcblxuXHRcdGlmIChlbmMpXG5cdFx0e1xuXHRcdFx0cHMgPSBmcy5yZWFkRmlsZShmaWxlLCBvcHRpb25zKTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdGxldCBvcHM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xuXHRcdFx0ZGVsZXRlIG9wcy5lbmNvZGluZztcblxuXHRcdFx0cHMgPSBmcy5yZWFkRmlsZShmaWxlLCBvcHMpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uIChidWYpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gaWNvbnYuZGVjb2RlKGJ1Ziwgb3B0aW9ucy5lbmNvZGluZyk7XG5cdFx0XHRcdH0pXG5cdFx0XHQ7XG5cdFx0fVxuXHR9XG5cdGVsc2UgaWYgKG9wdGlvbnMuYXV0b0RlY29kZSlcblx0e1xuXHRcdHBzID0gZnMucmVhZEZpbGUoZmlsZSwgb3B0aW9ucylcblx0XHRcdC50aGVuKGZ1bmN0aW9uIChidWYpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBzZWxmLl9hdXRvRGVjb2RlKGJ1Ziwgb3B0aW9ucyk7XG5cdFx0XHR9KVxuXHRcdDtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRwcyA9IGZzLnJlYWRGaWxlKGZpbGUsIG9wdGlvbnMpO1xuXHR9XG5cblx0cmV0dXJuIEJsdWViaXJkLnJlc29sdmUocHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGVTeW5jPFQgPSBzdHJpbmc+KGZpbGU6IHN0cmluZywgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlMiAmICh7XG5cdGVuY29kaW5nOiBzdHJpbmcsXG59IHwge1xuXHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW10sXG59KSk6IFRcbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZVN5bmM8VCA9IEJ1ZmZlcj4oZmlsZTogc3RyaW5nLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogVFxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlU3luYyhmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSA9IHt9KTogQnVmZmVyIHwgc3RyaW5nXG57XG5cdGxldCBzZWxmOiBXcmFwRlNJY29udi5JV3JhcEZTPHR5cGVvZiBmc0V4dHJhPiA9IHRoaXM7XG5cdGxldCBmcyA9IHNlbGZbU3ltRlNMaWJdIGFzIHR5cGVvZiBmc0V4dHJhO1xuXG5cdGxldCBwcztcblxuXHRpZiAob3B0aW9ucy5lbmNvZGluZylcblx0e1xuXHRcdGxldCBlbmMgPSBpY29udi5pc05vZGVFbmNvZGluZyhvcHRpb25zLmVuY29kaW5nKTtcblxuXHRcdGlmIChlbmMpXG5cdFx0e1xuXHRcdFx0cHMgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3B0aW9ucyk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRsZXQgb3BzOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcblx0XHRcdGRlbGV0ZSBvcHMuZW5jb2Rpbmc7XG5cblx0XHRcdHBzID0gaWNvbnYuZGVjb2RlKGZzLnJlYWRGaWxlU3luYyhmaWxlLCBvcHMpLCBvcHRpb25zLmVuY29kaW5nKTtcblx0XHR9XG5cdH1cblx0ZWxzZSBpZiAob3B0aW9ucy5hdXRvRGVjb2RlKVxuXHR7XG5cdFx0cHMgPSBzZWxmLl9hdXRvRGVjb2RlKGZzLnJlYWRGaWxlU3luYyhmaWxlLCBvcHRpb25zKSwgb3B0aW9ucyk7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0cHMgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3B0aW9ucyk7XG5cdH1cblxuXHRyZXR1cm4gcHM7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGV4cG9ydHMgYXMgdHlwZW9mIGltcG9ydCgnLi9jb3JlJyk7XG4iXX0=