"use strict";
/**
 * Created by user on 2019/3/17.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const clone = require("lodash/clone");
const iconv_jschardet_1 = require("iconv-jschardet");
const Bluebird = require("bluebird");
const stream = require("stream");
exports.SymFSLib = Symbol('fsLib');
function WrapFSIconv(fsLib) {
    let fs = clone(fsLib);
    Object.keys(fs)
        .forEach(k => {
        if (typeof fsLib[k] === 'function') {
            fs[k] = fsLib[k].bind(fsLib[k], fsLib);
        }
    });
    fs[exports.SymFSLib] = fsLib;
    fs.iconv = iconv_jschardet_1.default;
    fs.ensureWriteStream = ensureWriteStream.bind(fs);
    fs.saveFile = saveFile.bind(fs);
    fs.saveFileSync = saveFileSync.bind(fs);
    fs.loadFileSync = loadFileSync.bind(fs);
    fs.loadFile = loadFile.bind(fs);
    fs._createStreamPassThrough = _createStreamPassThrough.bind(fs);
    fs._outputStream = _outputStream.bind(fs);
    fs._autoDecode = _autoDecode.bind(fs);
    Object.defineProperty(exports, "__esModule", { value: true });
    // @ts-ignore
    fs.default = fs;
    return fs;
}
exports.WrapFSIconv = WrapFSIconv;
function ensureWriteStream(file) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    return fs.createWriteStream(file);
}
exports.ensureWriteStream = ensureWriteStream;
function saveFileSync(file, data, options = {}) {
    let fs = this[exports.SymFSLib];
    fs.ensureFileSync(file);
    if (options.encoding) {
        data = iconv_jschardet_1.default.encode(data, options.encoding);
    }
    fs.outputFileSync(file, data);
    return true;
}
exports.saveFileSync = saveFileSync;
function saveFile(file, data, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    return Bluebird
        .resolve(fs.ensureFile(file))
        .tap(function () {
        return new Bluebird(function (resolve, reject) {
            if (options.encoding) {
                data = iconv_jschardet_1.default.encode(data, options.encoding);
            }
            let readStream = self._createStreamPassThrough(data);
            let writeStream = self._outputStream(file, readStream);
            writeStream.on('error', reject);
            writeStream.on('finish', resolve);
        });
    })
        .thenReturn(true);
}
exports.saveFile = saveFile;
function _createStreamPassThrough(data) {
    let readStream = new stream.PassThrough();
    readStream.end(data);
    return readStream;
}
exports._createStreamPassThrough = _createStreamPassThrough;
function _outputStream(file, readStream) {
    let fs = this[exports.SymFSLib];
    let writeStream = fs.createWriteStream(file);
    readStream.pipe(writeStream);
    return writeStream;
}
exports._outputStream = _outputStream;
function _autoDecode(buf, options) {
    if (Array.isArray(options.autoDecode)) {
        let _do;
        let c = iconv_jschardet_1.default._enc(iconv_jschardet_1.default.detect(buf, true).name);
        for (let from of options.autoDecode) {
            let cd = iconv_jschardet_1.default.codec_data(from);
            let key;
            if (cd && cd.name) {
                key = iconv_jschardet_1.default._enc(cd.name);
                if (c === key) {
                    _do = key;
                    break;
                }
            }
        }
        if (_do) {
            return iconv_jschardet_1.default.encode(buf, null, options.encoding);
        }
        else {
            return buf;
        }
    }
    return iconv_jschardet_1.default.encode(buf);
}
exports._autoDecode = _autoDecode;
function loadFile(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFile(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = fs.readFile(file, ops)
                .then(function (buf) {
                return iconv_jschardet_1.default.decode(buf, options.encoding);
            });
        }
    }
    else if (options.autoDecode) {
        ps = fs.readFile(file, options)
            .then(function (buf) {
            return self._autoDecode(buf, options);
        });
    }
    else {
        ps = fs.readFile(file, options);
    }
    return Bluebird.resolve(ps);
}
exports.loadFile = loadFile;
function loadFileSync(file, options = {}) {
    let self = this;
    let fs = self[exports.SymFSLib];
    let ps;
    if (options.encoding) {
        let enc = iconv_jschardet_1.default.isNodeEncoding(options.encoding);
        if (enc) {
            ps = fs.readFileSync(file, options);
        }
        else {
            let ops = Object.assign({}, options);
            delete ops.encoding;
            ps = iconv_jschardet_1.default.decode(fs.readFileSync(file, ops), options.encoding);
        }
    }
    else if (options.autoDecode) {
        ps = self._autoDecode(fs.readFileSync(file, options), options);
    }
    else {
        ps = fs.readFileSync(file, options);
    }
    return ps;
}
exports.loadFileSync = loadFileSync;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUlILHNDQUF1QztBQUN2QyxxREFBb0M7QUFDcEMscUNBQXNDO0FBQ3RDLGlDQUFrQztBQUVyQixRQUFBLFFBQVEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFeEMsU0FBZ0IsV0FBVyxDQUE0QyxLQUFRO0lBRTlFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQTJCLENBQUM7SUFFaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7U0FDYixPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDWixJQUFJLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsRUFDbEM7WUFDQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7SUFDRixDQUFDLENBQUMsQ0FDRjtJQUVELEVBQUUsQ0FBQyxnQkFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXJCLEVBQUUsQ0FBQyxLQUFLLEdBQUcseUJBQUssQ0FBQztJQUVqQixFQUFFLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELEVBQUUsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNoQyxFQUFFLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFeEMsRUFBRSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEVBQUUsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUVoQyxFQUFFLENBQUMsd0JBQXdCLEdBQUcsd0JBQXdCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hFLEVBQUUsQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxQyxFQUFFLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFdEMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFFOUQsYUFBYTtJQUNiLEVBQUUsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBRWhCLE9BQU8sRUFBRSxDQUFDO0FBQ1gsQ0FBQztBQWxDRCxrQ0FrQ0M7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxJQUFZO0lBRTdDLElBQUksRUFBRSxHQUFJLElBQW1DLENBQUMsZ0JBQVEsQ0FBbUIsQ0FBQztJQUUxRSxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUFORCw4Q0FNQztBQUVELFNBQWdCLFlBQVksQ0FBQyxJQUFZLEVBQUUsSUFBSSxFQUFFLFVBQTJDLEVBQUU7SUFFN0YsSUFBSSxFQUFFLEdBQUksSUFBbUMsQ0FBQyxnQkFBUSxDQUFtQixDQUFDO0lBRTFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFeEIsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUNwQjtRQUNDLElBQUksR0FBRyx5QkFBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQzVDO0lBRUQsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFOUIsT0FBTyxJQUFJLENBQUM7QUFDYixDQUFDO0FBZEQsb0NBY0M7QUFFRCxTQUFnQixRQUFRLENBQUMsSUFBWSxFQUFFLElBQUksRUFBRSxVQUEyQyxFQUFFO0lBRXpGLElBQUksSUFBSSxHQUF3QyxJQUFJLENBQUM7SUFDckQsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFRLENBQW1CLENBQUM7SUFFMUMsT0FBTyxRQUFRO1NBQ2IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDNUIsR0FBRyxDQUFDO1FBRUosT0FBTyxJQUFJLFFBQVEsQ0FBQyxVQUFVLE9BQU8sRUFBRSxNQUFNO1lBRTVDLElBQUksT0FBTyxDQUFDLFFBQVEsRUFDcEI7Z0JBQ0MsSUFBSSxHQUFHLHlCQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDNUM7WUFFRCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFFdkQsV0FBVyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDaEMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUE7SUFDSCxDQUFDLENBQUM7U0FDRCxVQUFVLENBQUMsSUFBSSxDQUFDLENBQ2hCO0FBQ0gsQ0FBQztBQXpCRCw0QkF5QkM7QUFnRUQsU0FBZ0Isd0JBQXdCLENBQUMsSUFBSTtJQUU1QyxJQUFJLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMxQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JCLE9BQU8sVUFBVSxDQUFDO0FBQ25CLENBQUM7QUFMRCw0REFLQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxJQUFZLEVBQUUsVUFBMkI7SUFFdEUsSUFBSSxFQUFFLEdBQUksSUFBbUMsQ0FBQyxnQkFBUSxDQUFtQixDQUFDO0lBRTFFLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdCLE9BQU8sV0FBVyxDQUFDO0FBQ3BCLENBQUM7QUFQRCxzQ0FPQztBQU1ELFNBQWdCLFdBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBZ0Q7SUFFaEYsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFDckM7UUFDQyxJQUFJLEdBQVcsQ0FBQztRQUNoQixJQUFJLENBQUMsR0FBRyx5QkFBSyxDQUFDLElBQUksQ0FBQyx5QkFBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakQsS0FBSyxJQUFJLElBQUksSUFBSyxPQUFPLENBQUMsVUFBdUIsRUFDakQ7WUFDQyxJQUFJLEVBQUUsR0FBRyx5QkFBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQyxJQUFJLEdBQVcsQ0FBQztZQUVoQixJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUNqQjtnQkFDQyxHQUFHLEdBQUcseUJBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUUxQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQ2I7b0JBQ0MsR0FBRyxHQUFHLEdBQUcsQ0FBQztvQkFFVixNQUFNO2lCQUNOO2FBQ0Q7U0FDRDtRQUVELElBQUksR0FBRyxFQUNQO1lBQ0MsT0FBTyx5QkFBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNqRDthQUVEO1lBQ0MsT0FBTyxHQUFHLENBQUM7U0FDWDtLQUNEO0lBRUQsT0FBTyx5QkFBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBcENELGtDQW9DQztBQVFELFNBQWdCLFFBQVEsQ0FBQyxJQUFZLEVBQUUsVUFBbUQsRUFBRTtJQUUzRixJQUFJLElBQUksR0FBd0MsSUFBSSxDQUFDO0lBQ3JELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxnQkFBUSxDQUFtQixDQUFDO0lBRTFDLElBQUksRUFBZ0IsQ0FBQztJQUVyQixJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQ3BCO1FBQ0MsSUFBSSxHQUFHLEdBQUcseUJBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRWpELElBQUksR0FBRyxFQUNQO1lBQ0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ2hDO2FBRUQ7WUFDQyxJQUFJLEdBQUcsR0FBNEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUUsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDO1lBRXBCLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7aUJBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUc7Z0JBRWxCLE9BQU8seUJBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1QyxDQUFDLENBQUMsQ0FDRjtTQUNEO0tBQ0Q7U0FDSSxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQzNCO1FBQ0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQzthQUM3QixJQUFJLENBQUMsVUFBVSxHQUFHO1lBRWxCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQ0Y7S0FDRDtTQUVEO1FBQ0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ2hDO0lBRUQsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUEzQ0QsNEJBMkNDO0FBUUQsU0FBZ0IsWUFBWSxDQUFDLElBQVksRUFBRSxVQUFtRCxFQUFFO0lBRS9GLElBQUksSUFBSSxHQUF3QyxJQUFJLENBQUM7SUFDckQsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFRLENBQW1CLENBQUM7SUFFMUMsSUFBSSxFQUFFLENBQUM7SUFFUCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQ3BCO1FBQ0MsSUFBSSxHQUFHLEdBQUcseUJBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRWpELElBQUksR0FBRyxFQUNQO1lBQ0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3BDO2FBRUQ7WUFDQyxJQUFJLEdBQUcsR0FBNEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUUsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDO1lBRXBCLEVBQUUsR0FBRyx5QkFBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDaEU7S0FDRDtTQUNJLElBQUksT0FBTyxDQUFDLFVBQVUsRUFDM0I7UUFDQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztLQUMvRDtTQUVEO1FBQ0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3BDO0lBRUQsT0FBTyxFQUFFLENBQUM7QUFDWCxDQUFDO0FBakNELG9DQWlDQztBQUVELGtCQUFlLE9BQWtDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE5LzMvMTcuXG4gKi9cblxuaW1wb3J0IHsgdkVuY29kaW5nIH0gZnJvbSAnaWNvbnYtanNjaGFyZGV0JztcbmltcG9ydCBmc0V4dHJhID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCBjbG9uZSA9IHJlcXVpcmUoXCJsb2Rhc2gvY2xvbmVcIik7XG5pbXBvcnQgaWNvbnYgZnJvbSAnaWNvbnYtanNjaGFyZGV0JztcbmltcG9ydCBCbHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG5cbmV4cG9ydCBjb25zdCBTeW1GU0xpYiA9IFN5bWJvbCgnZnNMaWInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIFdyYXBGU0ljb252PEYgZXh0ZW5kcyB0eXBlb2YgZnNFeHRyYSA9IHR5cGVvZiBmc0V4dHJhPihmc0xpYjogRik6IFdyYXBGU0ljb252LklXcmFwRlM8Rj5cbntcblx0bGV0IGZzID0gY2xvbmUoZnNMaWIpIGFzIFdyYXBGU0ljb252LklXcmFwRlM8Rj47XG5cblx0T2JqZWN0LmtleXMoZnMpXG5cdFx0LmZvckVhY2goayA9PiB7XG5cdFx0XHRpZiAodHlwZW9mIGZzTGliW2tdID09PSAnZnVuY3Rpb24nKVxuXHRcdFx0e1xuXHRcdFx0XHRmc1trXSA9IGZzTGliW2tdLmJpbmQoZnNMaWJba10sIGZzTGliKTtcblx0XHRcdH1cblx0XHR9KVxuXHQ7XG5cblx0ZnNbU3ltRlNMaWJdID0gZnNMaWI7XG5cblx0ZnMuaWNvbnYgPSBpY29udjtcblxuXHRmcy5lbnN1cmVXcml0ZVN0cmVhbSA9IGVuc3VyZVdyaXRlU3RyZWFtLmJpbmQoZnMpO1xuXHRmcy5zYXZlRmlsZSA9IHNhdmVGaWxlLmJpbmQoZnMpO1xuXHRmcy5zYXZlRmlsZVN5bmMgPSBzYXZlRmlsZVN5bmMuYmluZChmcyk7XG5cblx0ZnMubG9hZEZpbGVTeW5jID0gbG9hZEZpbGVTeW5jLmJpbmQoZnMpO1xuXHRmcy5sb2FkRmlsZSA9IGxvYWRGaWxlLmJpbmQoZnMpO1xuXG5cdGZzLl9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaCA9IF9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaC5iaW5kKGZzKTtcblx0ZnMuX291dHB1dFN0cmVhbSA9IF9vdXRwdXRTdHJlYW0uYmluZChmcyk7XG5cdGZzLl9hdXRvRGVjb2RlID0gX2F1dG9EZWNvZGUuYmluZChmcyk7XG5cblx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuXG5cdC8vIEB0cy1pZ25vcmVcblx0ZnMuZGVmYXVsdCA9IGZzO1xuXG5cdHJldHVybiBmcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZVdyaXRlU3RyZWFtKGZpbGU6IHN0cmluZylcbntcblx0bGV0IGZzID0gKHRoaXMgYXMgYW55IGFzIFdyYXBGU0ljb252LklXcmFwRlMpW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRmcy5lbnN1cmVGaWxlU3luYyhmaWxlKTtcblx0cmV0dXJuIGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGVTeW5jKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9ucyA9IHt9KVxue1xuXHRsZXQgZnMgPSAodGhpcyBhcyBhbnkgYXMgV3JhcEZTSWNvbnYuSVdyYXBGUylbU3ltRlNMaWJdIGFzIHR5cGVvZiBmc0V4dHJhO1xuXG5cdGZzLmVuc3VyZUZpbGVTeW5jKGZpbGUpO1xuXG5cdGlmIChvcHRpb25zLmVuY29kaW5nKVxuXHR7XG5cdFx0ZGF0YSA9IGljb252LmVuY29kZShkYXRhLCBvcHRpb25zLmVuY29kaW5nKTtcblx0fVxuXG5cdGZzLm91dHB1dEZpbGVTeW5jKGZpbGUsIGRhdGEpO1xuXG5cdHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGUoZmlsZTogc3RyaW5nLCBkYXRhLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zID0ge30pXG57XG5cdGxldCBzZWxmOiBXcmFwRlNJY29udi5JV3JhcEZTPHR5cGVvZiBmc0V4dHJhPiA9IHRoaXM7XG5cdGxldCBmcyA9IHNlbGZbU3ltRlNMaWJdIGFzIHR5cGVvZiBmc0V4dHJhO1xuXG5cdHJldHVybiBCbHVlYmlyZFxuXHRcdC5yZXNvbHZlKGZzLmVuc3VyZUZpbGUoZmlsZSkpXG5cdFx0LnRhcChmdW5jdGlvbiAoKVxuXHRcdHtcblx0XHRcdHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHRcdHtcblx0XHRcdFx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRkYXRhID0gaWNvbnYuZW5jb2RlKGRhdGEsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IHJlYWRTdHJlYW0gPSBzZWxmLl9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaChkYXRhKTtcblx0XHRcdFx0bGV0IHdyaXRlU3RyZWFtID0gc2VsZi5fb3V0cHV0U3RyZWFtKGZpbGUsIHJlYWRTdHJlYW0pO1xuXG5cdFx0XHRcdHdyaXRlU3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG5cdFx0XHRcdHdyaXRlU3RyZWFtLm9uKCdmaW5pc2gnLCByZXNvbHZlKTtcblx0XHRcdH0pXG5cdFx0fSlcblx0XHQudGhlblJldHVybih0cnVlKVxuXHRcdDtcbn1cblxuZXhwb3J0IGRlY2xhcmUgbmFtZXNwYWNlIFdyYXBGU0ljb252XG57XG5cdGV4cG9ydCB0eXBlIElXcmFwRlM8RiBleHRlbmRzIHR5cGVvZiBmc0V4dHJhID0gdHlwZW9mIGZzRXh0cmE+ID0gRiAmXG5cdHtcblx0XHRbU3ltRlNMaWJdOiBGIHwgdHlwZW9mIGZzRXh0cmE7XG5cblx0XHRpY29udjogdHlwZW9mIGljb252O1xuXHRcdGVuc3VyZVdyaXRlU3RyZWFtKGZpbGU6IHN0cmluZyk6IGZzRXh0cmEuV3JpdGVTdHJlYW07XG5cblx0XHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5cdFx0c2F2ZUZpbGUoZmlsZTogc3RyaW5nLCBkYXRhLCBvcHRpb25zPzogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9ucyk6IEJsdWViaXJkPGJvb2xlYW4+O1xuXG5cdFx0c2F2ZUZpbGVTeW5jKGZpbGU6IHN0cmluZywgZGF0YSwgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnMpOiBib29sZWFuXG5cblx0XHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5cdFx0bG9hZEZpbGU8VCA9IHN0cmluZz4oZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUyICYgKHtcblx0XHRcdGVuY29kaW5nOiBzdHJpbmc7XG5cdFx0fSB8IHtcblx0XHRcdGF1dG9EZWNvZGU6IHRydWUgfCBzdHJpbmdbXTtcblx0XHR9KSk6IEJsdWViaXJkPFQ+O1xuXHRcdGxvYWRGaWxlPFQgPSBCdWZmZXI+KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IEJsdWViaXJkPFQ+O1xuXG5cdFx0bG9hZEZpbGVTeW5jPFQgPSBzdHJpbmc+KGZpbGU6IHN0cmluZywgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlMiAmICh7XG5cdFx0XHRlbmNvZGluZzogc3RyaW5nO1xuXHRcdH0gfCB7XG5cdFx0XHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW107XG5cdFx0fSkpOiBUO1xuXHRcdGxvYWRGaWxlU3luYzxUID0gQnVmZmVyPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM/OiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBUO1xuXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRcdF9jcmVhdGVTdHJlYW1QYXNzVGhyb3VnaChkYXRhOiB1bmtub3duKTogc3RyZWFtLlJlYWRhYmxlO1xuXHRcdF9vdXRwdXRTdHJlYW0oZmlsZTogc3RyaW5nLCByZWFkU3RyZWFtOiBzdHJlYW0uUmVhZGFibGUpOiBmc0V4dHJhLldyaXRlU3RyZWFtO1xuXG5cdFx0X2F1dG9EZWNvZGU8VD4oYnVmOiBULCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgJiB7XG5cdFx0XHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW107XG5cdFx0fSk6IFQgfCBzdHJpbmcgfCBCdWZmZXI7XG5cdFx0X2F1dG9EZWNvZGUoYnVmOiB1bmtub3duLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBCdWZmZXI7XG5cdH1cblxuXHRleHBvcnQgaW50ZXJmYWNlIElXcmFwRlNJY29udk9wdGlvbnNcblx0e1xuXHRcdGVuY29kaW5nPzogdkVuY29kaW5nO1xuXHR9XG5cblx0ZXhwb3J0IGludGVyZmFjZSBJV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGVcblx0e1xuXHRcdGVuY29kaW5nPzogc3RyaW5nO1xuXHRcdGZsYWc/OiBzdHJpbmc7XG5cblx0XHRhdXRvRGVjb2RlPzogYm9vbGVhbiB8IHN0cmluZ1tdLFxuXHR9XG5cblx0ZXhwb3J0IHR5cGUgSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlMiA9IElXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSAmIHtcblx0XHRlbmNvZGluZzogc3RyaW5nO1xuXHR9O1xuXG5cdGV4cG9ydCB0eXBlIElFbmNvZGluZyA9IHZFbmNvZGluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2NyZWF0ZVN0cmVhbVBhc3NUaHJvdWdoKGRhdGEpOiBzdHJlYW0uUmVhZGFibGVcbntcblx0bGV0IHJlYWRTdHJlYW0gPSBuZXcgc3RyZWFtLlBhc3NUaHJvdWdoKCk7XG5cdHJlYWRTdHJlYW0uZW5kKGRhdGEpO1xuXHRyZXR1cm4gcmVhZFN0cmVhbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9vdXRwdXRTdHJlYW0oZmlsZTogc3RyaW5nLCByZWFkU3RyZWFtOiBzdHJlYW0uUmVhZGFibGUpOiBmc0V4dHJhLldyaXRlU3RyZWFtXG57XG5cdGxldCBmcyA9ICh0aGlzIGFzIGFueSBhcyBXcmFwRlNJY29udi5JV3JhcEZTKVtTeW1GU0xpYl0gYXMgdHlwZW9mIGZzRXh0cmE7XG5cblx0bGV0IHdyaXRlU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZSk7XG5cdHJlYWRTdHJlYW0ucGlwZSh3cml0ZVN0cmVhbSk7XG5cdHJldHVybiB3cml0ZVN0cmVhbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hdXRvRGVjb2RlPFQ+KGJ1ZjogVCwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlICYge1xuXHRhdXRvRGVjb2RlOiB0cnVlIHwgc3RyaW5nW10sXG59KTogVCB8IHN0cmluZyB8IEJ1ZmZlclxuZXhwb3J0IGZ1bmN0aW9uIF9hdXRvRGVjb2RlKGJ1Ziwgb3B0aW9uczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlKTogQnVmZmVyXG5leHBvcnQgZnVuY3Rpb24gX2F1dG9EZWNvZGUoYnVmLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUpOiBzdHJpbmcgfCBCdWZmZXJcbntcblx0aWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucy5hdXRvRGVjb2RlKSlcblx0e1xuXHRcdGxldCBfZG86IHN0cmluZztcblx0XHRsZXQgYyA9IGljb252Ll9lbmMoaWNvbnYuZGV0ZWN0KGJ1ZiwgdHJ1ZSkubmFtZSk7XG5cblx0XHRmb3IgKGxldCBmcm9tIG9mIChvcHRpb25zLmF1dG9EZWNvZGUgYXMgc3RyaW5nW10pKVxuXHRcdHtcblx0XHRcdGxldCBjZCA9IGljb252LmNvZGVjX2RhdGEoZnJvbSk7XG5cdFx0XHRsZXQga2V5OiBzdHJpbmc7XG5cblx0XHRcdGlmIChjZCAmJiBjZC5uYW1lKVxuXHRcdFx0e1xuXHRcdFx0XHRrZXkgPSBpY29udi5fZW5jKGNkLm5hbWUpO1xuXG5cdFx0XHRcdGlmIChjID09PSBrZXkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRfZG8gPSBrZXk7XG5cblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChfZG8pXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGljb252LmVuY29kZShidWYsIG51bGwsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGJ1Zjtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaWNvbnYuZW5jb2RlKGJ1Zik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZTxUID0gc3RyaW5nPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZTIgJiAoe1xuXHRlbmNvZGluZzogc3RyaW5nLFxufSB8IHtcblx0YXV0b0RlY29kZTogdHJ1ZSB8IHN0cmluZ1tdLFxufSkpOiBCbHVlYmlyZDxUPlxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlPFQgPSBCdWZmZXI+KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IEJsdWViaXJkPFQ+XG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGUoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSB7fSk6IEJsdWViaXJkPEJ1ZmZlciB8IHN0cmluZz5cbntcblx0bGV0IHNlbGY6IFdyYXBGU0ljb252LklXcmFwRlM8dHlwZW9mIGZzRXh0cmE+ID0gdGhpcztcblx0bGV0IGZzID0gc2VsZltTeW1GU0xpYl0gYXMgdHlwZW9mIGZzRXh0cmE7XG5cblx0bGV0IHBzOiBQcm9taXNlPGFueT47XG5cblx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdHtcblx0XHRsZXQgZW5jID0gaWNvbnYuaXNOb2RlRW5jb2Rpbmcob3B0aW9ucy5lbmNvZGluZyk7XG5cblx0XHRpZiAoZW5jKVxuXHRcdHtcblx0XHRcdHBzID0gZnMucmVhZEZpbGUoZmlsZSwgb3B0aW9ucyk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRsZXQgb3BzOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcblx0XHRcdGRlbGV0ZSBvcHMuZW5jb2Rpbmc7XG5cblx0XHRcdHBzID0gZnMucmVhZEZpbGUoZmlsZSwgb3BzKVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbiAoYnVmKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIGljb252LmRlY29kZShidWYsIG9wdGlvbnMuZW5jb2RpbmcpO1xuXHRcdFx0XHR9KVxuXHRcdFx0O1xuXHRcdH1cblx0fVxuXHRlbHNlIGlmIChvcHRpb25zLmF1dG9EZWNvZGUpXG5cdHtcblx0XHRwcyA9IGZzLnJlYWRGaWxlKGZpbGUsIG9wdGlvbnMpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAoYnVmKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gc2VsZi5fYXV0b0RlY29kZShidWYsIG9wdGlvbnMpO1xuXHRcdFx0fSlcblx0XHQ7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0cHMgPSBmcy5yZWFkRmlsZShmaWxlLCBvcHRpb25zKTtcblx0fVxuXG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHBzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRGaWxlU3luYzxUID0gc3RyaW5nPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZTIgJiAoe1xuXHRlbmNvZGluZzogc3RyaW5nLFxufSB8IHtcblx0YXV0b0RlY29kZTogdHJ1ZSB8IHN0cmluZ1tdLFxufSkpOiBUXG5leHBvcnQgZnVuY3Rpb24gbG9hZEZpbGVTeW5jPFQgPSBCdWZmZXI+KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IFdyYXBGU0ljb252LklXcmFwRlNJY29udk9wdGlvbnNMb2FkRmlsZSk6IFRcbmV4cG9ydCBmdW5jdGlvbiBsb2FkRmlsZVN5bmMoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBXcmFwRlNJY29udi5JV3JhcEZTSWNvbnZPcHRpb25zTG9hZEZpbGUgPSB7fSk6IEJ1ZmZlciB8IHN0cmluZ1xue1xuXHRsZXQgc2VsZjogV3JhcEZTSWNvbnYuSVdyYXBGUzx0eXBlb2YgZnNFeHRyYT4gPSB0aGlzO1xuXHRsZXQgZnMgPSBzZWxmW1N5bUZTTGliXSBhcyB0eXBlb2YgZnNFeHRyYTtcblxuXHRsZXQgcHM7XG5cblx0aWYgKG9wdGlvbnMuZW5jb2RpbmcpXG5cdHtcblx0XHRsZXQgZW5jID0gaWNvbnYuaXNOb2RlRW5jb2Rpbmcob3B0aW9ucy5lbmNvZGluZyk7XG5cblx0XHRpZiAoZW5jKVxuXHRcdHtcblx0XHRcdHBzID0gZnMucmVhZEZpbGVTeW5jKGZpbGUsIG9wdGlvbnMpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0bGV0IG9wczogV3JhcEZTSWNvbnYuSVdyYXBGU0ljb252T3B0aW9uc0xvYWRGaWxlID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG5cdFx0XHRkZWxldGUgb3BzLmVuY29kaW5nO1xuXG5cdFx0XHRwcyA9IGljb252LmRlY29kZShmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3BzKSwgb3B0aW9ucy5lbmNvZGluZyk7XG5cdFx0fVxuXHR9XG5cdGVsc2UgaWYgKG9wdGlvbnMuYXV0b0RlY29kZSlcblx0e1xuXHRcdHBzID0gc2VsZi5fYXV0b0RlY29kZShmcy5yZWFkRmlsZVN5bmMoZmlsZSwgb3B0aW9ucyksIG9wdGlvbnMpO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdHBzID0gZnMucmVhZEZpbGVTeW5jKGZpbGUsIG9wdGlvbnMpO1xuXHR9XG5cblx0cmV0dXJuIHBzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vY29yZScpO1xuIl19